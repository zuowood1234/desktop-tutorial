# 股票短线交易助手需求文档

## 1. 项目概述
开发一个专注于 A 股市场的短线交易辅助网页应用（v3.0 版本）。
系统利用 DeepSeek 大模型，结合**技术面（Technical）**与**情绪面（Sentiment）**双重策略，每日为用户生成短线操作建议。
核心特色在于**量化维度的历史回测与资金收益模拟**，通过数据直观验证 AI 建议的盈利能力，并计算超额收益（Alpha）。

## 2. 核心功能

### 2.1 用户与持仓管理 (已实现)
*   **用户系统**：
    *   支持用户注册/登录/注销。
    *   **权限管理**：区分普通用户与管理员（Admin），管理员可管理用户状态及回测权限。
*   **自选股管理 (Watchlist)**：
    *   支持批量导入股票代码。
    *   支持为股票打标签（如：科技、重仓、观察）。
    *   支持动态增删改查。

### 2.2 智能建议系统 (v3.0 进阶策略)
*   **数据源**：
    *   基础行情：AkShare (开/收/高/低/量/额)。
    *   技术指标：MA, MACD, KDJ, RSI, OBV 等。
*   **双重策略逻辑**：
    *   **技术派**：基于传动的技术指标金叉/死叉、超买/超卖进行判定。
    *   **情绪增强派 (v3.0)**：引入大盘环境（Market Context）与量比（Volume Ratio）因子，识别诱多与主力资金行为。
*   **分析输出**：
    *   给出明确的操作建议（买入/卖出/持有/观望）。
    *   分别计算技术得分与情绪得分。
    *   提供详细的自然语言分析理由。
    *   **Token 计费**：系统后台自动记录每次分析消耗的 Token 数量。

### 2.3 深度历史回测与收益计算 (已实现)
*   **回测机制**：
    *   支持标准回测（30天）与年度长跑（365天）。
    *   支持批处理（Batch Processing）以提高回测效率。
*   **收益率计算**：
    *   **累计收益率**：策略 vs 基准（如沪深300或个股持有）。
    *   **Alpha (超额收益)**：计算 AI 策略相对于基准的超额回报。
    *   **英雄榜**：自动生成年度冠军策略与个股排行。
*   **可视化**：
    *   提供 CSV 战报下载。
    *   前端展示“策略长跑英雄榜”。

### 2.4 数据存储与架构升级 (当前重点)
*   **现状**：目前使用本地 **SQLite** (`investor_assistant.db`) 存储用户数据、自选股及历史建议。
*   **目标**：迁移至云端 **Supabase (PostgreSQL)**。
    *   **数据表**：
        *   `users`: 用户信息、权限、Token消耗。
        *   `watchlist`: 自选股关联表 (User <-> Stock)，包含标签。
        *   `daily_recommendations`: 每日分析的历史存档 (User + Stock + Date)。
        *   `token_logs`: 详细的 API 调用日志。
    *   **迁移要求**：
        *   保留现有 SQLite 数据，编写脚本将其迁移至 Supabase。
        *   修改后端 `database.py` 适配 Supabase 客户端。

## 3. 技术栈
*   **前端/应用层**：Streamlit (Python Web Framework)。
*   **后端逻辑**：Python (处理数据获取、AI 交互、回测计算)。
*   **数据库**：**Supabase (PostgreSQL)** (原 SQLite)。
*   **AI 模型**：DeepSeek-V3 / DeepSeek-R1 (API)。
*   **数据源**：AkShare (开源财经数据接口)。
*   **部署**：本地运行 / Streamlit Cloud / Docker。
