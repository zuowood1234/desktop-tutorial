# 机构级A股量化回测系统需求文档 (V2.0 实战升级版)

**核心定位**：单只自选股的策略调优与复盘系统，支持极度精细的A股实盘规则模拟，底层具备全市场历史数据的托底能力。
**技术栈**：AkShare (数据获取) + Pandas/NumPy/pandas_ta (向量化及指标计算) + Backtesting.py/自定义引擎 (回测核心与可视化) + DeepSeek (高阶策略引擎) + Streamlit (前端UI)

---

## 一、 数据库架构设计 (Data Infrastructure)

为了解决单次回测查询极速与每日增量更新的矛盾，采用 **“双模架构 (Lambda Architecture)”**。

### 1. 存储结构策略
*   **历史冷库 (The Vault)**：按股票代码分区存储（极利于单票回测的 I/O 性能，如 `Vault/600519.parquet`），覆盖历史全量数据。
*   **今日热库 (The Buffer)**：每日 16:00 自动抓取当日全市场 5000+ 股票的截面数据，按日期存储（如 `Buffer/2026-02-22.parquet`），保证极速写入。
*   **读取合并机制**：回测单只股票时，系统自动取出冷库中该股票的历史数据，并与热库中该股票最近几天的新增数据进行内存拼接 (`pd.concat`)。周末定期将热库数据洗入冷库归档。

### 2. 行情主表 (`daily_price`) 字段规范
**严禁使用单纯的前复权数据计算市值，并摒弃 `ffill` 填充停牌数据的坏习惯。**
采用**主日历对齐 (Master Calendar Alignment)** 技术，对缺失日保留 `NaN`。

| 字段名 | 描述 | 用途说明 |
| :--- | :--- | :--- |
| `Date` | 交易日期 | 基于沪深300指数的绝对交易日历基准 |
| `Code` | 股票代码 | |
| `Open_Raw` / `High` / `Low` / `Close_Raw` | **真实价格组** (不复权) | **仅用于计算**：真实盈亏、买入可得股数、佣金印花税、市值、换手率。 |
| `Open_Qfq` / `High` / `Low` / `Close_Qfq` | **前复权价格组** | **仅用于计算**：均线(MA)、MACD、布林带等所有基于价格走势的技术指标。 |
| `Volume` & `Turnover` | 真实成交量与成交额 | |
| `limit_up` / `limit_down` | 当日真实的涨停/跌停价 | 每天自动计算并入库，解决历史各板块涨幅限制变更问题 (10%, 20%, 30%)，回测绝不依赖次日乘数预估。 |
| `is_trading` | 当日是否交易 (布尔值) | 用于标记停牌日。停牌日价格为 `NaN`，回测引擎遇 `False` 直接跳过任何交易指令产生及动作。 |
| `is_st` | 今日是否为ST股 (布尔值) | 提供基础风控过滤，默认不交易。 |

### 3. 特征工程：Super_Parquet (C表+D表的融合体)
为了实现前端UI只做逻辑筛选而不做复杂计算的目标，所有中间指标和分类缓存都在数据清洗入库时（或每日跑批时）完成预计算，形成包含上百个特征列的大宽表。

#### A. 技术指标库 (pandas_ta生成)
*   **基础类**：MACD (12, 26, 9), RSI (14), KDJ, 均线(5/10/20/60/120/250), BIAS(乖离率), CCI, WR, ADX, DMI, ATR, OBV, Bollinger Bands(布林带), Donchian Channel(唐奇安通道).
*   **衍生状态类**：`Limit_Up_Count` (近5日涨停次数，判断极强连板动能)。

#### B. 财务与因子库 (分类与过滤基因)
*   **价值/估值基因**：`PE_TTM`, `PB`, `PE_Percentile` (该股市盈率在其自身历史 N 年中的分位值), `PB_Relative` (个股PB / 申万行业当天平均PB，需外挂行业维度表)。
*   **动量/速度基因**：`Price_Loc_250` (价格处于过去250日[最低, 最高]区间的位置0-1), `Distance_MA20` (20日乖离率)。
*   **质量/盈利基因**：`ROE_TTM`, 净利润同比, 营收同比。（**必须严格按照财报真实发布日 Announcement Date 映射到 K 线，严禁未来函数**）
*   **波动/体质基因**：`ATR_Ratio` (ATR/股价), `Turnover_ZScore` (今日换手率偏离过去20日均值的标准差，抓异动放量), `Volatility_30`。

---

## 二、 核心回测引擎与 A 股实战规则 (Trading Logic)

底层回测类(`Broker`)必须严格向A股恶劣的实盘环境妥协，绝不允许“虚空交易”。

### 1. 资金与仓位管理 (资金模型：All-in)
*   **初始本金**：默认 200,000 元整（前端可调的正整数）。
*   **买入数量限制**：必须是 100 股（1手）的整数倍。计算公式为 `(总资金 / 买入价) 向下取整到百位`。
*   **交易摩擦成本**：
    *   **买入成本**：滑点买入价提拉设定值 (如 +0.1%)，扣除佣金（默认万分之2.5，单笔最低5元）。
    *   **卖出成本**：滑点卖出价下压设定值 (如 -0.1%)，扣除佣金（同上），扣除印花税（默认千分之0.5）。

### 2. A 股绝对禁区 (熔断与失效逻辑)
*   **绝对 T+1 制度**：T 日买入的股票份额，无论盘中怎么发卖出信号，当日持仓处于锁定状态，最早只能在 T+1 日卖单成交。
*   **涨跌停板熔断判定**：
    *   **尾盘买入策略 (T日尾盘买)**：如果 T 日 `最低价 == 涨停价` 或 `收盘价 == 涨停价`（即全天一字板或尾盘封死涨停），则判定指令失效，买不进。
    *   **开盘买入策略 (T+1日开机买)**：如果 T+1 日 `开盘价 == 涨停价` (一字开盘)，判定指令失效，买不进。
    *   **卖出同理**：如果遇到跌停封死，即使触发止损单也无法成交，必须继续承受浮亏直到能够撮合成交。

---

## 三、 前端 UI 与双轨制策略构建器 (Dual-Track UI)

系统前端(Streamlit)不只是数据展示，而是极具自由度的交易员工作台。

### 1. 基础环境与全局刹车面板 (Core Settings)
提供带默认值的快捷输入：
*   **底层环境**：初始本金(20w)、滑点(0.1%)、佣金、印花税、时间轴(如过去3年)、买入点位选择(尾盘/次日开盘)。
*   **单笔风控 (刹车)**：
    *   固定百分比止损 (如 `-8%`) / 固定止盈。
    *   动态追踪止损 (如回撤 `5%` 平仓)。
    *   最大持仓时长 (如 `15天` 不盈利强制调仓)。

### 2. 第一轨：经典指标扫描仪 (UI 图形化极速测试)
*   **技术形态勾选**：均线多头排列、收盘价突破某条均线、MACD金叉、短期放量激增(量比)、布林带上轨突破。
*   **基本面滤网**：滑动条控制“市值范围”、ROE 下限、PE上限（过滤垃圾股）。

### 3. 第二轨：DeepSeek 高阶辅佐引擎 (The Magic Box)
对于无法用固定 UI 穷举的骚操作（如：三连阴后缩量收十字星）。
*   **自然语言输入框**：用户输入复杂的盘口或选股想法。
*   **AI 解析机制**：点击调用 DeepSeek API，大模型基于底层包含 100 多个字段的 `Super_Parquet` 字典，输出一段完美适配此数据库的 Pandas `DataFrame.query()` 或布尔索引条件代码。
*   **确认执行**：后台将“第一轨UI勾选的条件” 与 “第二轨AI生成的条件” 取交集 (`AND`)，输送给回测引擎。

---

## 四、 策略评估与多维 Alpha 分析 (Performance & Benchmark)

评价报告拒绝唯收益论，重点展示策略在多大程度上跑赢了对应的市场生态。

### 1. 核心绩效数据板 (Core Metrics)
*   年化收益率 & 累计收益率。
*   **卡玛比率 (Calmar)** & **最大回撤 (Max Drawdown)** (资金曲线最核心的风险指标)。
*   胜率 (Win Rate) & 盈亏比 (P/L Ratio) & 平均持仓天数。

### 2. 多维度基准透视 (Benchmark Radar)
在策略报告中加入对应的市场指数同期走势图：
*   **基准指数群**：上证指数、深证成指、科创50指数、创业板指、中证500指数。
*   **能力呈现**：不仅看绝对赚了多少钱，更要直观展示：在某指数大跌的周期内，该策略通过自选股是否实现了相对 Alpha 收益（例如画一条 `策略累计净值 / 对应指数净值` 的相对强弱曲线）。

### 3. 专业图表输出 (Interactive Charts)
*   基于 `Backtesting.py` 的可视化模块（魔改后适用），生成高交互性的 K线图，并精准绘制出历史每一个 `Buy` (绿箭头) 和 `Sell` (红箭头) 的点位，以及资金阴影缩水图，便于复盘每一个操作细节。